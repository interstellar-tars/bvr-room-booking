export default {
  async fetch(request, env, ctx) {
    const corsHeaders = {
      "Access-Control-Allow-Origin": "*", // Or limit to your Pages domain
      "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
      "Access-Control-Allow-Headers": "Content-Type",
    };

    // Handle CORS preflight
    if (request.method === "OPTIONS") {
      return new Response(null, {
        status: 204,
        headers: corsHeaders
      });
    }

    const url = new URL(request.url);

    // Handle GET /rooms
    if (url.pathname === "/rooms" && request.method === "GET") {
      const data = {};
      for (let i = 1; i <= 6; i++) {
        const key = `room_${i}`;
        const value = await env.ROOMS_KV.get(key);
        data[key] = value ? JSON.parse(value) : { status: "vacant", username: "" };
      }
      return new Response(JSON.stringify(data), {
        headers: {
          "Content-Type": "application/json",
          ...corsHeaders
        }
      });
    }

    // Handle POST /update
    if (url.pathname === "/update" && request.method === "POST") {
      try {
        const body = await request.json();
        const { roomId, status, username } = body;
        if (!roomId || !status) {
          return new Response(JSON.stringify({ error: "Missing fields" }), {
            status: 400,
            headers: { "Content-Type": "application/json", ...corsHeaders }
          });
        }

        await env.ROOMS_KV.put(roomId, JSON.stringify({ status, username }));
        return new Response(JSON.stringify({ success: true }), {
          headers: {
            "Content-Type": "application/json",
            ...corsHeaders
          }
        });
      } catch (err) {
        return new Response(JSON.stringify({ error: "Invalid JSON or internal error" }), {
          status: 500,
          headers: { "Content-Type": "application/json", ...corsHeaders }
        });
      }
    }

    // Not Found
    return new Response("Not found", { status: 404, headers: corsHeaders });
  }
}
